---
title: "Why Is Spatially Explicit Discretization Necessary?"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{whysed}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  fig.path = "man/figures/whysed/",
  fig.dpi = 150
)
```


We demonstrate the necessity of the spatial explicit discretization (discretization with spatial soft constraints) method using the `Depression.csv` data from the `gdverse` package. In this analysis, we select `Depression_prevalence` as the dependent variable Y and `PopulationDensity` as the independent variable X. X is randomly shuffled, and the q-value is calculated using both discretization methods that do and do not account for spatial soft constraints, with the process repeated 1000 times. We selected hierarchical clustering with spatial soft constraints and natural breaks method to represent explicit and implicit spatial discretization, respectively. At the same time, hierarchical clustering without spatial soft constraints is used as a control in the experiment. The hierarchical clustering with spatial soft constraints method and hierarchical clustering without spatial soft constraints method were implemented using the `ClustGeo` package and the natural breaks method is implemented based on the `sdsfun` package. In subsequent analyses, all discretization methods applied will discretize the dataset into five strata for the calculation of the q-values.

## Install Necessary R Packages

```r
install.packages("gdverse",dep = TRUE)
# install.packages("devtools")
devtools::install_github("ausgis/sesp",build_vignettes = TRUE,dep = TRUE)
```

## The spatial autocorrelation of the example data

```{r moran_data}
dt = system.file('extdata/Depression.csv',package = 'gdverse') |>
  readr::read_csv() |>
  sf::st_as_sf(coords = c('X','Y'), crs = 4326) |>
  dplyr::select(y = Depression_prevelence,
                x = PopulationDensity)

sdsfun::moran_test(dt)
```

## Q value corresponding to spatial implicit discretization

```{r prepare}
geom = sf::st_geometry(dt)
y = dt$y
x = dt$x
gdist = stats::as.dist(sdsfun::sf_distance_matrix(dt))
hclustgeo_disc = \(xv,discnum,alpha = 0.5){
  D0 = stats::dist(xv)
  resh = ClustGeo::hclustgeo(D0,gdist,alpha = alpha)
  return(stats::cutree(resh,discnum))
}
```

```{r qv_sid}
x_naturaldisc = sdsfun::discretize_vector(x,5,method = "natural")
x_hclustdisc = hclustgeo_disc(x,5,alpha = 0)
qv_naturaldisc = gdverse::factor_detector(y,x_naturaldisc)[[1]]
qv_naturaldisc
qv_hclustdisc = gdverse::factor_detector(y,x_hclustdisc)[[1]]
qv_hclustdisc
```

## A Monte Carlo simulation experiment demonstrating the necessity of spatial explicit discretization

In the repeated experiment, X is shuffled 1000 times, and the global Moran's I for the shuffled X is calculated. If the Moran's I of the shuffled X is significant and greater than 0, it is used as the degree of spatial soft constraint for the spatially constrained hierarchical clustering. Otherwise, the degree of soft constraint is set to 0. Subsequently, the q-values for each simulation round is computed.

```r
mc_simq = \(times = 5000, cores = 6){
  doclust = FALSE
  if (inherits(cores, "cluster")) {
    doclust = TRUE
  } else if (cores > 1) {
    doclust = TRUE
    cores = parallel::makeCluster(cores)
    on.exit(parallel::stopCluster(cores), add = TRUE)
  }

  calcul_q = \(n_sim) {
    x_sim = sample(x)
    g = sdsfun::moran_test(
      sf::st_set_geometry(tibble::tibble(x_sim = x_sim),geom)
    )
    moran = dplyr::pull(g$result,2)
    moran_p = dplyr::pull(g$result,6)
    x_sed = hclustgeo_disc(x_sim,
                           alpha = ifelse(moran_p<=0.05 & moran>0,
                                          moran, 0))
    qv = gdverse::factor_detector(y,x_sed)[[1]]
    res = tibble::tibble(qv_sed = qv, moran = moran,
                         moran_p = moran_p)
    return(res)
  }

  if (doclust) {
    parallel::clusterExport(cores,varlist = c("geom","y","x","gdist","hclustgeo_disc"))
    out_g = parallel::parLapply(cores,seq(1,times,by = 1),calcul_q)
    out_g = tibble::as_tibble(do.call(rbind, out_g))
  } else {
    out_g = purrr::map_dfr(seq(1,times,by = 1),calcul_q)
  }
  return(out_g)
}

qv = mc_simq(times = 1000, cores = 12)
```

```{r plot_mcres,fig.width=4.05,fig.height=2.85}
ggplot2::ggplot(data = qv, ggplot2::aes(x = qv_sed)) +
  ggplot2::geom_histogram(ggplot2::aes(y = ggplot2::after_stat(density)),
                          bins = 50, fill = "skyblue",
                          color = "black", alpha = 0.7) +
  ggplot2::geom_density(color = "red", linewidth = 1.2) +
  ggplot2::labs(title = "Monte Carlo Simulation Results",
                x = "Q Value",
                y = "Density") +
  ggplot2::theme_minimal()
```

The Monte Carlo simulation experiment indicates that spatial implicit discretization underestimates the q-value of the variable when there is moderate spatial autocorrelation, highlighting the necessity of spatial explicit discretization.
