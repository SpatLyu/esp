---
title: "Spatially Explicit Stratified Power Model"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{sesp}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---



## Install and load R packages

```r
install.packages(c("sf","gdverse"), dep = T)
# install.packages("devtools")
devtools::install_github("stscl/sesp",build_vignettes = TRUE,dep = TRUE)
```



``` r
library(sf)
## Linking to GEOS 3.12.1, GDAL 3.8.4, PROJ 9.3.1; sf_use_s2() is TRUE
library(sesp)
library(gdverse)
```

## Equivalence of Q Values in the Native Geographical Detector and Linear Regression Framework


``` r
NTDs = sf::st_as_sf(gdverse::NTDs, coords = c('X','Y'))

system.time({
go1 = sesp(incidence ~ ., data = NTDs, discvar = 'none',
           model = 'ols', overlay = 'intersection')
})
##    user  system elapsed 
##    0.35    0.03    0.53

system.time({
go2 = gd(incidence ~ ., data = NTDs,
         type = c('factor','interaction'))
})
##    user  system elapsed 
##    0.06    0.00    0.08
```

### Factor detector


``` r
go1$factor
## # A tibble: 3 × 5
##   Variable  Qvalue   AIC   BIC LogLik
##   <chr>      <dbl> <dbl> <dbl>  <dbl>
## 1 watershed  0.597  77.1  77.1  -28.5
## 2 elevation  0.644  50.3  50.3  -17.1
## 3 soiltype   0.512 104.  104.   -46.2
go2$factor
## # A tibble: 3 × 3
##   variable  `Q-statistic` `P-value`
##   <chr>             <dbl>     <dbl>
## 1 watershed         0.638  0.000129
## 2 elevation         0.607  0.0434  
## 3 soiltype          0.386  0.372
```

### Interaction detector


``` r
go1$interaction
## # A tibble: 3 × 7
##   Variable              Interaction    Qv1   Qv2  Qv12 Variable1 Variable2
##   <chr>                 <chr>        <dbl> <dbl> <dbl> <chr>     <chr>    
## 1 watershed ∩ elevation Enhance, bi- 0.597 0.644 0.677 watershed elevation
## 2 watershed ∩ soiltype  Enhance, bi- 0.597 0.512 0.671 watershed soiltype 
## 3 elevation ∩ soiltype  Enhance, bi- 0.644 0.512 0.671 elevation soiltype
go2$interaction
## # A tibble: 3 × 6
##   variable1 variable2 Interaction  `Variable1 Q-statistics` `Variable2 Q-statistics`
##   <chr>     <chr>     <chr>                           <dbl>                    <dbl>
## 1 watershed elevation Enhance, bi-                    0.638                    0.607
## 2 watershed soiltype  Enhance, bi-                    0.638                    0.386
## 3 elevation soiltype  Enhance, bi-                    0.607                    0.386
## # ℹ 1 more variable: `Variable1 and Variable2 interact Q-statistics` <dbl>
```

## Spatially Explicit Stratified Power Model Under The Linear Regression Framework

Using the same data as [the gdverse idsa vignette](https://stscl.github.io/gdverse/articles/idsa.html):


``` r
depression = system.file('extdata/Depression.csv',package = 'gdverse') |>
  readr::read_csv() |>
  sf::st_as_sf(coords = c('X','Y'), crs = 4326)
## Rows: 1072 Columns: 13
## ── Column specification ───────────────────────────────────────────────────────────────────────────
## Delimiter: ","
## dbl (13): X, Y, Depression_prevelence, PopulationDensity, Population65, NoHealthInsurance, Neig...
## 
## ℹ Use `spec()` to retrieve the full column specification for this data.
## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.
depression
## Simple feature collection with 1072 features and 11 fields
## Geometry type: POINT
## Dimension:     XY
## Bounding box:  xmin: -83.1795 ymin: 32.11464 xmax: -78.6023 ymax: 35.17354
## Geodetic CRS:  WGS 84
## # A tibble: 1,072 × 12
##    Depression_prevelence PopulationDensity Population65 NoHealthInsurance Neighbor_Disadvantage
##  *                 <dbl>             <dbl>        <dbl>             <dbl>                 <dbl>
##  1                  23.1              61.5         22.5              7.98               -0.0525
##  2                  22.8              58.3         16.8             11.0                -0.254 
##  3                  23.2              35.9         24.5              9.31               -0.0540
##  4                  21.8              76.1         21.8             13.2                 0.0731
##  5                  20.7              47.3         22.0             11                   0.763 
##  6                  21.3              32.5         19.2             13.0                 0.422 
##  7                  22                36.9         19.2             10.8                 0.113 
##  8                  21.2              61.5         15.9              8.57               -0.154 
##  9                  22.7              67.2         15.7             17.8                -0.320 
## 10                  20.6             254.          11.3             12.7                 0.457 
## # ℹ 1,062 more rows
## # ℹ 7 more variables: Beer <dbl>, MentalHealthPati <dbl>, NatureParks <dbl>, Casinos <dbl>,
## #   DrinkingPlaces <dbl>, X.HouseRent <dbl>, geometry <POINT [°]>
```

### SESP With Linear Regression


``` r
system.time({
  g1 = sesp(Depression_prevelence ~ ., data = depression,
            model = 'ols', overlay = 'intersection', cores = 8)
})
##    user  system elapsed 
##    5.57    0.75   32.89
g1
## ***          Spatially Explicit Stratified Power     
## 
##  Q values are estimated using *Ordinary Least Square* 
## 
##  -------------- Global Power of Determinant : ------------
## Variable              Qvalue AIC      BIC      LogLik    
## PopulationDensity     0.205  4502.661 4502.661 -2245.331 
## Population65          0.187  4528.900 4528.900 -2257.450 
## NoHealthInsurance     0.213  4493.959 4493.959 -2239.980 
## Neighbor_Disadvantage 0.216  4489.263 4489.263 -2237.631 
## Beer                  0.244  4454.614 4454.614 -2218.307 
## MentalHealthPati      0.238  4458.638 4458.638 -2222.319 
## NatureParks           0.156  4566.472 4566.472 -2277.236 
## Casinos               0.224  4483.450 4483.450 -2232.725 
## DrinkingPlaces        0.151  4573.448 4573.448 -2280.724 
## X.HouseRent           0.204  4505.741 4505.741 -2245.871 
## 
##  -------------  Global Variable Interaction : ------------
## Variable                                    Interaction  
## PopulationDensity ∩ Population65          Enhance, bi- 
## PopulationDensity ∩ NoHealthInsurance     Enhance, bi- 
## PopulationDensity ∩ Neighbor_Disadvantage Enhance, bi- 
## PopulationDensity ∩ Beer                  Enhance, bi- 
## PopulationDensity ∩ MentalHealthPati      Enhance, bi- 
## PopulationDensity ∩ NatureParks           Enhance, bi- 
## PopulationDensity ∩ Casinos               Enhance, bi- 
## PopulationDensity ∩ DrinkingPlaces        Enhance, bi- 
## PopulationDensity ∩ X.HouseRent           Enhance, bi- 
## Population65 ∩ NoHealthInsurance          Enhance, bi- 
## 
## ! Only the top ten items of global scale are displayed.
## ! The others can be accessed through specific subsets.
plot(g1,slicenum = 10) +
  ggplot2::theme(axis.text.x = ggplot2::element_text(
                                  angle = 30,vjust = 0.85,hjust = 0.75)
                )
```

![**Figure 1**. Results of SESP With Linear Regression](../man/figures/sesp/g1-1.png)

### SESP With Spatial Lag Regression


``` r
system.time({
  g2 = sesp(Depression_prevelence ~ .,
            data = depression,
            model = 'lag', cores = 8)
})
##    user  system elapsed 
##    8.31    1.06  264.67
g2
## ***          Spatially Explicit Stratified Power     
## 
##  Q values are estimated using *Spatial Lag Model* 
## 
##  -------------- Global Power of Determinant : ------------
## Variable              Qvalue AIC      BIC      LogLik    
## PopulationDensity     0.162  4336.703 4336.703 -2161.352 
## Population65          0.145  4363.627 4363.627 -2173.813 
## NoHealthInsurance     0.173  4341.150 4341.150 -2162.575 
## Neighbor_Disadvantage 0.177  4331.916 4331.916 -2157.958 
## Beer                  0.217  4293.261 4293.261 -2136.630 
## MentalHealthPati      0.224  4305.675 4305.675 -2143.838 
## NatureParks           0.109  4380.138 4380.138 -2183.069 
## Casinos               0.200  4325.222 4325.222 -2152.611 
## DrinkingPlaces        0.101  4379.217 4379.217 -2182.609 
## X.HouseRent           0.145  4340.049 4340.049 -2163.024 
## 
##  -------------  Global Variable Interaction : ------------
## Variable                                    Interaction  
## PopulationDensity ∩ Population65          Enhance, bi- 
## PopulationDensity ∩ NoHealthInsurance     Enhance, bi- 
## PopulationDensity ∩ Neighbor_Disadvantage Weaken, uni- 
## PopulationDensity ∩ Beer                  Weaken, uni- 
## PopulationDensity ∩ MentalHealthPati      Enhance, bi- 
## PopulationDensity ∩ NatureParks           Enhance, bi- 
## PopulationDensity ∩ Casinos               Enhance, bi- 
## PopulationDensity ∩ DrinkingPlaces        Weaken, uni- 
## PopulationDensity ∩ X.HouseRent           Enhance, bi- 
## Population65 ∩ NoHealthInsurance          Enhance, bi- 
## 
## ! Only the top ten items of global scale are displayed.
## ! The others can be accessed through specific subsets.
plot(g2,slicenum = 10) +
  ggplot2::theme(axis.text.x = ggplot2::element_text(
                                  angle = 30,vjust = 0.85,hjust = 0.75)
                )
```

![**Figure 2**. Results of SESP With Spatial Lag Regression](../man/figures/sesp/g2-1.png)

### SESP With Spatial Error Regression


``` r
system.time({
  g3 = sesp(Depression_prevelence ~ .,
            data = depression,
            model = 'error', cores = 8)
})
##    user  system elapsed 
##   10.58    1.66  142.44
g3
## ***          Spatially Explicit Stratified Power     
## 
##  Q values are estimated using *Spatial Error Model* 
## 
##  -------------- Global Power of Determinant : ------------
## Variable              Qvalue AIC      BIC      LogLik    
## PopulationDensity     0.203  4295.874 4295.874 -2140.937 
## Population65          0.182  4325.794 4325.794 -2154.897 
## NoHealthInsurance     0.206  4306.366 4306.366 -2145.183 
## Neighbor_Disadvantage 0.211  4292.852 4292.852 -2138.426 
## Beer                  0.236  4261.339 4261.339 -2120.669 
## MentalHealthPati      0.226  4290.270 4290.270 -2137.135 
## NatureParks           0.152  4343.985 4343.985 -2164.992 
## Casinos               0.202  4291.347 4291.347 -2135.673 
## DrinkingPlaces        0.146  4339.579 4339.579 -2162.790 
## X.HouseRent           0.197  4287.536 4287.536 -2135.768 
## 
##  -------------  Global Variable Interaction : ------------
## Variable                                    Interaction  
## PopulationDensity ∩ Population65          Enhance, bi- 
## PopulationDensity ∩ NoHealthInsurance     Enhance, bi- 
## PopulationDensity ∩ Neighbor_Disadvantage Enhance, bi- 
## PopulationDensity ∩ Beer                  Enhance, bi- 
## PopulationDensity ∩ MentalHealthPati      Enhance, bi- 
## PopulationDensity ∩ NatureParks           Enhance, bi- 
## PopulationDensity ∩ Casinos               Enhance, bi- 
## PopulationDensity ∩ DrinkingPlaces        Weaken, uni- 
## PopulationDensity ∩ X.HouseRent           Enhance, bi- 
## Population65 ∩ NoHealthInsurance          Enhance, bi- 
## 
## ! Only the top ten items of global scale are displayed.
## ! The others can be accessed through specific subsets.
plot(g3,slicenum = 10) +
  ggplot2::theme(axis.text.x = ggplot2::element_text(
                                  angle = 30,vjust = 0.85,hjust = 0.75)
                )
```

![**Figure 3**. Results of SESP With Spatial Error Regression](../man/figures/sesp/g3-1.png)

### SESP With Spatial Durbin Regression


``` r
system.time({
  g4 = sesp(Depression_prevelence ~ ., data = depression,
            model = 'lag', durbin = TRUE, cores = 8)
})
##    user  system elapsed 
##   11.04    1.50  267.14
g4
## ***          Spatially Explicit Stratified Power     
## 
##  Q values are estimated using *Spatial Durbin Model* 
## 
##  -------------- Global Power of Determinant : ------------
## Variable              Qvalue AIC      BIC      LogLik    
## PopulationDensity     0.210  4300.669 4300.669 -2139.335 
## Population65          0.197  4329.029 4329.029 -2151.515 
## NoHealthInsurance     0.227  4305.640 4305.640 -2139.820 
## Neighbor_Disadvantage 0.229  4295.740 4295.740 -2132.870 
## Beer                  0.262  4260.269 4260.269 -2113.135 
## MentalHealthPati      0.284  4261.358 4261.358 -2115.679 
## NatureParks           0.167  4345.486 4345.486 -2161.743 
## Casinos               0.278  4269.780 4269.780 -2117.890 
## DrinkingPlaces        0.158  4341.539 4341.539 -2159.769 
## X.HouseRent           0.222  4285.855 4285.855 -2129.927 
## 
##  -------------  Global Variable Interaction : ------------
## Variable                                    Interaction  
## PopulationDensity ∩ Population65          Enhance, bi- 
## PopulationDensity ∩ NoHealthInsurance     Enhance, bi- 
## PopulationDensity ∩ Neighbor_Disadvantage Enhance, bi- 
## PopulationDensity ∩ Beer                  Enhance, bi- 
## PopulationDensity ∩ MentalHealthPati      Enhance, bi- 
## PopulationDensity ∩ NatureParks           Enhance, bi- 
## PopulationDensity ∩ Casinos               Enhance, bi- 
## PopulationDensity ∩ DrinkingPlaces        Weaken, uni- 
## PopulationDensity ∩ X.HouseRent           Enhance, bi- 
## Population65 ∩ NoHealthInsurance          Enhance, bi- 
## 
## ! Only the top ten items of global scale are displayed.
## ! The others can be accessed through specific subsets.
plot(g4,slicenum = 10) +
  ggplot2::theme(axis.text.x = ggplot2::element_text(
                                  angle = 30,vjust = 0.85,hjust = 0.75)
                )
```

![**Figure 4**. Results of SESP With Spatial Durbin Regression](../man/figures/sesp/g4-1.png)

### SESP With Geographically Weighted Regression


``` r
system.time({
  g5 = sesp(Depression_prevelence ~ .,
            data = depression,
            model = 'gwr', cores = 8)
})
##    user  system elapsed 
##   11.53    1.53  131.87
g5
## ***          Spatially Explicit Stratified Power     
## 
##  Q values are estimated using *Geographically Weighted Regression* 
## 
##  -------------- Global Power of Determinant : ------------
## Variable              Qvalue AIC      
## PopulationDensity     0.390  4222.993 
## Population65          0.362  4267.337 
## NoHealthInsurance     0.334  4313.012 
## Neighbor_Disadvantage 0.303  4359.302 
## Beer                  0.335  4312.556 
## MentalHealthPati      0.322  4331.471 
## NatureParks           0.335  4311.999 
## Casinos               0.289  4382.091 
## DrinkingPlaces        0.303  4360.807 
## X.HouseRent           0.445  4129.926 
## 
##  -------------  Global Variable Interaction : ------------
## Variable                                    Interaction       
## PopulationDensity ∩ Population65          Weaken, nonlinear 
## PopulationDensity ∩ NoHealthInsurance     Weaken, uni-      
## PopulationDensity ∩ Neighbor_Disadvantage Weaken, uni-      
## PopulationDensity ∩ Beer                  Weaken, uni-      
## PopulationDensity ∩ MentalHealthPati      Weaken, uni-      
## PopulationDensity ∩ NatureParks           Enhance, bi-      
## PopulationDensity ∩ Casinos               Weaken, uni-      
## PopulationDensity ∩ DrinkingPlaces        Weaken, uni-      
## PopulationDensity ∩ X.HouseRent           Weaken, nonlinear 
## Population65 ∩ NoHealthInsurance          Weaken, nonlinear 
## 
## ! Only the top ten items of global scale are displayed.
## ! The others can be accessed through specific subsets.
plot(g5,slicenum = 10) +
  ggplot2::theme(axis.text.x = ggplot2::element_text(
                                  angle = 30,vjust = 0.85,hjust = 0.75)
                )
```

![**Figure 5**. Results of SESP With Geographically Weighted Regression](../man/figures/sesp/g5-1.png)

### Results of optimal spatial discretization


``` r
plot_optdisc = \(g){
 gmap = sf::st_set_geometry(g$optdisc,sf::st_geometry(depression))

 fig1 = seq_along(g$optdisc) |>
   purrr::map(\(.x) ggplot2::ggplot(data = gmap) +
                ggplot2::geom_sf(ggplot2::aes(color = factor(g$optdisc[,.x,drop = TRUE])),
                                 alpha = .65, size = 0.5) +
                ggplot2::labs(color = 'zones') +
                ggplot2::theme_void() +
                ggplot2::theme(
                  legend.position = "none")
                ) %>%
   patchwork::wrap_plots(ncol = 3, byrow = TRUE) +
   patchwork::plot_annotation(
     tag_levels = 'a',
     tag_prefix = '(',
     tag_suffix = ')',
     tag_sep = '',
     theme = ggplot2::theme(plot.tag = ggplot2::element_text(family = "serif"),
                            plot.tag.position = "topleft"))
 return(fig1)
}
```


``` r
plot_optdisc(g1)
```

![**Figure 6**. Optimal spatial discretization result with linear regression operator. Subfigures (a)–(j) depict the optimal spatial discretizations for the variables PopulationDensity, Population65, NoHealthInsurance, Neighbor_Disadvantage, Beer, MentalHealthPati, NatureParks, Casinos, DrinkingPlaces, and X.HouseRent, respectively.](../man/figures/sesp/optdisc1-1.png)


``` r
plot_optdisc(g2)
```

![**Figure 7**. Optimal spatial discretization result with spatial lag regression operator. Subfigures (a)–(j) depict the optimal spatial discretizations for the variables PopulationDensity, Population65, NoHealthInsurance, Neighbor_Disadvantage, Beer, MentalHealthPati, NatureParks, Casinos, DrinkingPlaces, and X.HouseRent, respectively.](../man/figures/sesp/optdisc2-1.png)


``` r
plot_optdisc(g3)
```

![**Figure 8**. Optimal spatial discretization result with spatial error regression operator. Subfigures (a)–(j) depict the optimal spatial discretizations for the variables PopulationDensity, Population65, NoHealthInsurance, Neighbor_Disadvantage, Beer, MentalHealthPati, NatureParks, Casinos, DrinkingPlaces, and X.HouseRent, respectively.](../man/figures/sesp/optdisc3-1.png)


``` r
plot_optdisc(g4)
```

![**Figure 9**. Optimal spatial discretization result with spatial durbin regression operator. Subfigures (a)–(j) depict the optimal spatial discretizations for the variables PopulationDensity, Population65, NoHealthInsurance, Neighbor_Disadvantage, Beer, MentalHealthPati, NatureParks, Casinos, DrinkingPlaces, and X.HouseRent, respectively.](../man/figures/sesp/optdisc4-1.png)


``` r
plot_optdisc(g5)
```

![**Figure 10**. Optimal spatial discretization result with geographically weighted regression operator. Subfigures (a)–(j) depict the optimal spatial discretizations for the variables PopulationDensity, Population65, NoHealthInsurance, Neighbor_Disadvantage, Beer, MentalHealthPati, NatureParks, Casinos, DrinkingPlaces, and X.HouseRent, respectively.](../man/figures/sesp/optdisc5-1.png)
