---
title: "Spatially Explicit Stratified Power Model"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{sesp}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---



## Install and load R packages

```r
install.packages(c("sf","gdverse"), dep = T)
# install.packages("devtools")
devtools::install_github("ausgis/sesp",
                         build_vignettes = TRUE,
                         dep = TRUE)
```



``` r
library(sf)
## Linking to GEOS 3.12.1, GDAL 3.8.4, PROJ 9.3.1; sf_use_s2() is TRUE
library(sesp)
library(gdverse)
```

## Equivalence of Q Values in the Native Geographical Detector and Linear Regression Framework


``` r
NTDs = sf::st_as_sf(gdverse::NTDs, coords = c('X','Y'))

system.time({
go1 = sesp(incidence ~ ., data = NTDs, discvar = 'none',
           model = 'ols', overlay = 'intersection')
})
##    user  system elapsed 
##    0.17    0.02    0.66

system.time({
go2 = gd(incidence ~ ., data = NTDs,
         type = c('factor','interaction'))
})
##    user  system elapsed 
##    0.04    0.00    0.06
```

### Factor detector


``` r
go1$factor
## # A tibble: 3 × 5
##   Variable  Qvalue    AIC    BIC LogLik
##   <chr>      <dbl>  <dbl>  <dbl>  <dbl>
## 1 watershed  0.638 -10.0  -10.0   15.0 
## 2 elevation  0.607   1.18   1.18   7.41
## 3 soiltype   0.386  79.7   79.7  -33.8
go2$factor
## # A tibble: 3 × 3
##   variable  `Q-statistic` `P-value`
##   <chr>             <dbl>     <dbl>
## 1 watershed         0.638  0.000129
## 2 elevation         0.607  0.0434  
## 3 soiltype          0.386  0.372
```

### Interaction detector


``` r
go1$interaction
## # A tibble: 3 × 5
##   Variable              Interaction    Qv1   Qv2  Qv12
##   <chr>                 <chr>        <dbl> <dbl> <dbl>
## 1 watershed ∩ elevation Enhance, bi- 0.638 0.607 0.714
## 2 watershed ∩ soiltype  Enhance, bi- 0.638 0.386 0.736
## 3 elevation ∩ soiltype  Enhance, bi- 0.607 0.386 0.664
go2$interaction
## # A tibble: 3 × 6
##   variable1 variable2 Interaction  `Variable1 Q-statistics` `Variable2 Q-statistics`
##   <chr>     <chr>     <chr>                           <dbl>                    <dbl>
## 1 watershed elevation Enhance, bi-                    0.638                    0.607
## 2 watershed soiltype  Enhance, bi-                    0.638                    0.386
## 3 elevation soiltype  Enhance, bi-                    0.607                    0.386
## # ℹ 1 more variable: `Variable1 and Variable2 interact Q-statistics` <dbl>
```

## Spatially Explicit Stratified Power Model Under The Spatial Linear Regression Framework

Using the same data as [the gdverse idsa vignette](https://stscl.github.io/gdverse/articles/idsa.html):


``` r
depression = system.file('extdata/Depression.csv',package = 'gdverse') |>
  readr::read_csv() |>
  sf::st_as_sf(coords = c('X','Y'), crs = 4326)
## Rows: 1072 Columns: 13
## ── Column specification ───────────────────────────────────────────────────────────────────────────
## Delimiter: ","
## dbl (13): X, Y, Depression_prevelence, PopulationDensity, Population65, NoHealthInsurance, Neig...
## 
## ℹ Use `spec()` to retrieve the full column specification for this data.
## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.
depression
## Simple feature collection with 1072 features and 11 fields
## Geometry type: POINT
## Dimension:     XY
## Bounding box:  xmin: -83.1795 ymin: 32.11464 xmax: -78.6023 ymax: 35.17354
## Geodetic CRS:  WGS 84
## # A tibble: 1,072 × 12
##    Depression_prevelence PopulationDensity Population65 NoHealthInsurance Neighbor_Disadvantage
##  *                 <dbl>             <dbl>        <dbl>             <dbl>                 <dbl>
##  1                  23.1              61.5         22.5              7.98               -0.0525
##  2                  22.8              58.3         16.8             11.0                -0.254 
##  3                  23.2              35.9         24.5              9.31               -0.0540
##  4                  21.8              76.1         21.8             13.2                 0.0731
##  5                  20.7              47.3         22.0             11                   0.763 
##  6                  21.3              32.5         19.2             13.0                 0.422 
##  7                  22                36.9         19.2             10.8                 0.113 
##  8                  21.2              61.5         15.9              8.57               -0.154 
##  9                  22.7              67.2         15.7             17.8                -0.320 
## 10                  20.6             254.          11.3             12.7                 0.457 
## # ℹ 1,062 more rows
## # ℹ 7 more variables: Beer <dbl>, MentalHealthPati <dbl>, NatureParks <dbl>, Casinos <dbl>,
## #   DrinkingPlaces <dbl>, X.HouseRent <dbl>, geometry <POINT [°]>
```

### Apply natural breaks to the response variable to generate 3 local zones


``` r
yzone = sdsfun::discretize_vector(depression$Depression_prevelence,3,method = 'natural')
depressionmap = sf::st_sf(zones = yzone,geom = sf::st_geometry(depression))

ggplot2::ggplot(data = depressionmap) +
    ggplot2::geom_sf(ggplot2::aes(color = factor(zones)), alpha = .65) +
    ggplot2::labs(color = 'zones') +
    ggplot2::theme_bw()
```

![**Figure 1**. Zones of Depression Prevelence](../man/figures/sesp/Depression_prevelence-1.png)

### Spatially Explicit Stratified Power Model With Linear Regression


``` r
system.time({
  g1 = sesp(Depression_prevelence ~ ., data = depression, yzone = yzone,
            model = 'ols', overlay = 'intersection', cores = 8)
})
##    user  system elapsed 
##    2.70    0.45   28.22
g1
## ***          Spatially Explicit Stratified Power     
## 
##  Q values are estimated using *Ordinary Least Square* 
## 
##  -------------- Global Power of Determinat : ------------
## Variable              Qvalue AIC      BIC      LogLik    
## PopulationDensity     0.202  4505.365 4505.365 -2246.682 
## Population65          0.217  4489.645 4489.645 -2236.822 
## NoHealthInsurance     0.255  4435.513 4435.513 -2209.756 
## Neighbor_Disadvantage 0.298  4367.560 4367.560 -2177.780 
## Beer                  0.181  4533.101 4533.101 -2260.551 
## MentalHealthPati      0.281  4397.257 4397.257 -2190.628 
## NatureParks           0.181  4533.589 4533.589 -2260.794 
## Casinos               0.205  4503.507 4503.507 -2244.754 
## DrinkingPlaces        0.212  4492.654 4492.654 -2240.327 
## X.HouseRent           0.224  4477.724 4477.724 -2231.862 
## 
##  ------------- Global Variable Interaction : ------------
## Variable                                    Interaction  
## PopulationDensity ∩ Population65          Enhance, bi- 
## PopulationDensity ∩ NoHealthInsurance     Enhance, bi- 
## PopulationDensity ∩ Neighbor_Disadvantage Enhance, bi- 
## PopulationDensity ∩ Beer                  Enhance, bi- 
## PopulationDensity ∩ MentalHealthPati      Enhance, bi- 
## PopulationDensity ∩ NatureParks           Enhance, bi- 
## PopulationDensity ∩ Casinos               Enhance, bi- 
## PopulationDensity ∩ DrinkingPlaces        Enhance, bi- 
## PopulationDensity ∩ X.HouseRent           Enhance, bi- 
## Population65 ∩ NoHealthInsurance          Enhance, bi- 
## 
## ! Only the top ten items of global scale are displayed.
## ! The others can be accessed through specific subsets.
```

### Spatially Explicit Stratified Power Model With Spatial Lag Regression


``` r
system.time({
  g2 = sesp(Depression_prevelence ~ ., data = depression,
            yzone = yzone, model = 'lag', cores = 8)
})
##    user  system elapsed 
##    6.34    0.55  262.99
g2
## ***          Spatially Explicit Stratified Power     
## 
##  Q values are estimated using *Spatial Lag Model* 
## 
##  -------------- Global Power of Determinat : ------------
## Variable              Qvalue AIC      BIC      LogLik    
## PopulationDensity     0.154  4333.170 4333.170 -2159.585 
## Population65          0.176  4330.340 4330.340 -2156.170 
## NoHealthInsurance     0.216  4267.870 4267.870 -2124.935 
## Neighbor_Disadvantage 0.295  4246.726 4246.726 -2116.363 
## Beer                  0.230  4284.607 4284.607 -2133.304 
## MentalHealthPati      0.277  4272.981 4272.981 -2127.490 
## NatureParks           0.138  4364.690 4364.690 -2175.345 
## Casinos               0.153  4346.299 4346.299 -2166.149 
## DrinkingPlaces        0.171  4322.830 4322.830 -2154.415 
## X.HouseRent           0.186  4317.249 4317.249 -2150.625 
## 
##  ------------- Global Variable Interaction : ------------
## Variable                                    Interaction  
## PopulationDensity ∩ Population65          Enhance, bi- 
## PopulationDensity ∩ NoHealthInsurance     Enhance, bi- 
## PopulationDensity ∩ Neighbor_Disadvantage Enhance, bi- 
## PopulationDensity ∩ Beer                  Enhance, bi- 
## PopulationDensity ∩ MentalHealthPati      Weaken, uni- 
## PopulationDensity ∩ NatureParks           Weaken, uni- 
## PopulationDensity ∩ Casinos               Enhance, bi- 
## PopulationDensity ∩ DrinkingPlaces        Enhance, bi- 
## PopulationDensity ∩ X.HouseRent           Enhance, bi- 
## Population65 ∩ NoHealthInsurance          Enhance, bi- 
## 
## ! Only the top ten items of global scale are displayed.
## ! The others can be accessed through specific subsets.
```

### Spatially Explicit Stratified Power Model With Spatial Error Regression


``` r
system.time({
  g3 = sesp(Depression_prevelence ~ ., data = depression,
            yzone = yzone, model = 'error', cores = 8)
})
##    user  system elapsed 
##    8.53    1.12  145.08
g3
## ***          Spatially Explicit Stratified Power     
## 
##  Q values are estimated using *Spatial Error Model* 
## 
##  -------------- Global Power of Determinat : ------------
## Variable              Qvalue AIC      BIC      LogLik    
## PopulationDensity     0.199  4288.640 4288.640 -2137.320 
## Population65          0.210  4288.833 4288.833 -2135.417 
## NoHealthInsurance     0.253  4230.432 4230.432 -2106.216 
## Neighbor_Disadvantage 0.293  4240.407 4240.407 -2113.204 
## Beer                  0.243  4258.978 4258.978 -2120.489 
## MentalHealthPati      0.265  4262.356 4262.356 -2122.178 
## NatureParks           0.171  4325.679 4325.679 -2155.839 
## Casinos               0.184  4305.020 4305.020 -2145.510 
## DrinkingPlaces        0.209  4290.838 4290.838 -2138.419 
## X.HouseRent           0.218  4281.633 4281.633 -2132.817 
## 
##  ------------- Global Variable Interaction : ------------
## Variable                                    Interaction  
## PopulationDensity ∩ Population65          Enhance, bi- 
## PopulationDensity ∩ NoHealthInsurance     Enhance, bi- 
## PopulationDensity ∩ Neighbor_Disadvantage Enhance, bi- 
## PopulationDensity ∩ Beer                  Enhance, bi- 
## PopulationDensity ∩ MentalHealthPati      Enhance, bi- 
## PopulationDensity ∩ NatureParks           Weaken, uni- 
## PopulationDensity ∩ Casinos               Enhance, bi- 
## PopulationDensity ∩ DrinkingPlaces        Enhance, bi- 
## PopulationDensity ∩ X.HouseRent           Enhance, bi- 
## Population65 ∩ NoHealthInsurance          Enhance, bi- 
## 
## ! Only the top ten items of global scale are displayed.
## ! The others can be accessed through specific subsets.
```

### Spatially Explicit Stratified Power Model With Spatial Durbin Regression


``` r
system.time({
  g4 = sesp(Depression_prevelence ~ ., data = depression, yzone = yzone,
            model = 'lag', durbin = TRUE, cores = 8)
})
##    user  system elapsed 
##    5.42    0.41  263.98
g4
## ***          Spatially Explicit Stratified Power     
## 
##  Q values are estimated using *Spatial Durbin Model* 
## 
##  -------------- Global Power of Determinat : ------------
## Variable              Qvalue AIC      BIC      LogLik    
## PopulationDensity     0.211  4291.372 4291.372 -2134.686 
## Population65          0.230  4290.935 4290.935 -2130.467 
## NoHealthInsurance     0.261  4238.839 4238.839 -2104.420 
## Neighbor_Disadvantage 0.315  4233.116 4233.116 -2105.558 
## Beer                  0.185  4341.729 4341.729 -2159.865 
## MentalHealthPati      0.324  4234.956 4234.956 -2102.478 
## NatureParks           0.252  4285.895 4285.895 -2125.948 
## Casinos               0.237  4291.052 4291.052 -2132.526 
## DrinkingPlaces        0.215  4293.266 4293.266 -2135.633 
## X.HouseRent           0.236  4280.601 4280.601 -2129.301 
## 
##  ------------- Global Variable Interaction : ------------
## Variable                                    Interaction  
## PopulationDensity ∩ Population65          Enhance, bi- 
## PopulationDensity ∩ NoHealthInsurance     Enhance, bi- 
## PopulationDensity ∩ Neighbor_Disadvantage Enhance, bi- 
## PopulationDensity ∩ Beer                  Enhance, bi- 
## PopulationDensity ∩ MentalHealthPati      Enhance, bi- 
## PopulationDensity ∩ NatureParks           Enhance, bi- 
## PopulationDensity ∩ Casinos               Enhance, bi- 
## PopulationDensity ∩ DrinkingPlaces        Enhance, bi- 
## PopulationDensity ∩ X.HouseRent           Enhance, bi- 
## Population65 ∩ NoHealthInsurance          Enhance, bi- 
## 
## ! Only the top ten items of global scale are displayed.
## ! The others can be accessed through specific subsets.
```

### Spatially Explicit Stratified Power Model With Geographically Weighted Regression


``` r
system.time({
  g5 = sesp(Depression_prevelence ~ ., data = depression,
            yzone = yzone, model = 'gwr', cores = 8)
})
##    user  system elapsed 
##    8.01    0.73  142.86
g5
## ***          Spatially Explicit Stratified Power     
## 
##  Q values are estimated using *Geographically Weighted Regression* 
## 
##  -------------- Global Power of Determinat : ------------
## Variable              Qvalue AIC      
## PopulationDensity     0.366  4260.457 
## Population65          0.277  4397.511 
## NoHealthInsurance     0.254  4429.183 
## Neighbor_Disadvantage 0.360  4266.675 
## Beer                  0.324  4328.330 
## MentalHealthPati      0.341  4298.605 
## NatureParks           0.266  4412.671 
## Casinos               0.307  4354.933 
## DrinkingPlaces        0.301  4362.084 
## X.HouseRent           0.458  4102.198 
## 
##  ------------- Global Variable Interaction : ------------
## Variable                                    Interaction  
## PopulationDensity ∩ Population65          Enhance, bi- 
## PopulationDensity ∩ NoHealthInsurance     Enhance, bi- 
## PopulationDensity ∩ Neighbor_Disadvantage Enhance, bi- 
## PopulationDensity ∩ Beer                  Enhance, bi- 
## PopulationDensity ∩ MentalHealthPati      Enhance, bi- 
## PopulationDensity ∩ NatureParks           Weaken, uni- 
## PopulationDensity ∩ Casinos               Weaken, uni- 
## PopulationDensity ∩ DrinkingPlaces        Enhance, bi- 
## PopulationDensity ∩ X.HouseRent           Weaken, uni- 
## Population65 ∩ NoHealthInsurance          Enhance, bi- 
## 
## ! Only the top ten items of global scale are displayed.
## ! The others can be accessed through specific subsets.
```

### Results of local zones-based power of determinat


``` r
g1$localq
## # A tibble: 30 × 6
##    Variable              Qvalue   AIC   BIC LogLik  Zone
##    <chr>                  <dbl> <dbl> <dbl>  <dbl> <int>
##  1 PopulationDensity     0.0674  677.  677.  -333.     3
##  2 Population65          0.155   660.  660.  -322.     3
##  3 NoHealthInsurance     0.0743  680.  680.  -332.     3
##  4 Neighbor_Disadvantage 0.118   665.  665.  -327.     3
##  5 Beer                  0.0529  681.  681.  -334.     3
##  6 MentalHealthPati      0.0774  679.  679.  -332.     3
##  7 NatureParks           0.0600  679.  679.  -334.     3
##  8 Casinos               0.0894  674.  674.  -330.     3
##  9 DrinkingPlaces        0.0480  682.  682.  -335.     3
## 10 X.HouseRent           0.0677  679.  679.  -333.     3
## # ℹ 20 more rows
g2$localq
## # A tibble: 30 × 6
##    Variable              Qvalue   AIC   BIC LogLik  Zone
##    <chr>                  <dbl> <dbl> <dbl>  <dbl> <int>
##  1 PopulationDensity     0.0721  678.  678.  -332.     3
##  2 Population65          0.153   662.  662.  -322.     3
##  3 NoHealthInsurance     0.0795  680.  680.  -331.     3
##  4 Neighbor_Disadvantage 0.120   667.  667.  -327.     3
##  5 Beer                  0.0994  676.  676.  -329.     3
##  6 MentalHealthPati      0.0816  680.  680.  -331.     3
##  7 NatureParks           0.0646  680.  680.  -333.     3
##  8 Casinos               0.0921  674.  674.  -330.     3
##  9 DrinkingPlaces        0.0525  683.  683.  -334.     3
## 10 X.HouseRent           0.0730  681.  681.  -332.     3
## # ℹ 20 more rows
g3$localq
## # A tibble: 30 × 6
##    Variable              Qvalue   AIC   BIC LogLik  Zone
##    <chr>                  <dbl> <dbl> <dbl>  <dbl> <int>
##  1 PopulationDensity     0.0673  679.  679.  -332.     3
##  2 Population65          0.153   660.  660.  -321.     3
##  3 NoHealthInsurance     0.0738  681.  681.  -332.     3
##  4 Neighbor_Disadvantage 0.118   667.  667.  -327.     3
##  5 Beer                  0.0964  676.  676.  -329.     3
##  6 MentalHealthPati      0.0774  681.  681.  -332.     3
##  7 NatureParks           0.0600  681.  681.  -334.     3
##  8 Casinos               0.0889  674.  674.  -330.     3
##  9 DrinkingPlaces        0.0478  683.  683.  -335.     3
## 10 X.HouseRent           0.0677  681.  681.  -333.     3
## # ℹ 20 more rows
g4$localq
## # A tibble: 30 × 6
##    Variable              Qvalue   AIC   BIC LogLik  Zone
##    <chr>                  <dbl> <dbl> <dbl>  <dbl> <int>
##  1 PopulationDensity     0.103   679.  679.  -329.     3
##  2 Population65          0.201   659.  659.  -315.     3
##  3 NoHealthInsurance     0.155   674.  674.  -322.     3
##  4 Neighbor_Disadvantage 0.136   671.  671.  -324.     3
##  5 Beer                  0.0994  680.  680.  -329.     3
##  6 MentalHealthPati      0.165   671.  671.  -320.     3
##  7 NatureParks           0.187   668.  668.  -317.     3
##  8 Casinos               0.120   679.  679.  -326.     3
##  9 DrinkingPlaces        0.0967  680.  680.  -329.     3
## 10 X.HouseRent           0.135   670.  670.  -324.     3
## # ℹ 20 more rows
g5$localq
## # A tibble: 30 × 4
##    Variable              Qvalue   AIC  Zone
##    <chr>                  <dbl> <dbl> <int>
##  1 PopulationDensity     0.191   644.     3
##  2 Population65          0.183   647.     3
##  3 NoHealthInsurance     0.0858  667.     3
##  4 Neighbor_Disadvantage 0.119   658.     3
##  5 Beer                  0.144   657.     3
##  6 MentalHealthPati      0.0963  665.     3
##  7 NatureParks           0.0849  668.     3
##  8 Casinos               0.201   643.     3
##  9 DrinkingPlaces        0.165   655.     3
## 10 X.HouseRent           0.145   657.     3
## # ℹ 20 more rows
```

### Results of optimal spatial discretization


``` r
plot_optdisc = \(g){
 gmap = sf::st_set_geometry(g$optdisc,sf::st_geometry(depression))

 fig1 = seq_along(g$optdisc) |>
   purrr::map(\(.x) ggplot2::ggplot(data = gmap) +
                ggplot2::geom_sf(ggplot2::aes(color = factor(g$optdisc[,.x,drop = TRUE])),
                                 alpha = .65) +
                ggplot2::labs(color = 'zones') +
                ggplot2::theme_void() +
                ggplot2::theme(
                  legend.position = "none")
                ) %>%
   patchwork::wrap_plots(ncol = 3, byrow = TRUE) +
   patchwork::plot_annotation(
     tag_levels = 'a',
     tag_prefix = '(',
     tag_suffix = ')',
     tag_sep = '',
     theme = ggplot2::theme(plot.tag = ggplot2::element_text(family = "serif"),
                            plot.tag.position = "topleft"))
 return(fig1)
}
```


``` r
plot_optdisc(g1)
```

![**Figure 2**. Optimal spatial discretization result with linear regression operator. Subfigures (a)–(j) depict the optimal spatial discretizations for the variables PopulationDensity, Population65, NoHealthInsurance, Neighbor_Disadvantage, Beer, MentalHealthPati, NatureParks, Casinos, DrinkingPlaces, and X.HouseRent, respectively.](../man/figures/sesp/optdisc1-1.png)


``` r
plot_optdisc(g2)
```

![**Figure 3**. Optimal spatial discretization result with spatial lag regression operator. Subfigures (a)–(j) depict the optimal spatial discretizations for the variables PopulationDensity, Population65, NoHealthInsurance, Neighbor_Disadvantage, Beer, MentalHealthPati, NatureParks, Casinos, DrinkingPlaces, and X.HouseRent, respectively.](../man/figures/sesp/optdisc2-1.png)


``` r
plot_optdisc(g3)
```

![**Figure 4**. Optimal spatial discretization result with spatial error regression operator. Subfigures (a)–(j) depict the optimal spatial discretizations for the variables PopulationDensity, Population65, NoHealthInsurance, Neighbor_Disadvantage, Beer, MentalHealthPati, NatureParks, Casinos, DrinkingPlaces, and X.HouseRent, respectively.](../man/figures/sesp/optdisc3-1.png)


``` r
plot_optdisc(g4)
```

![**Figure 5**. Optimal spatial discretization result with spatial durbin regression operator. Subfigures (a)–(j) depict the optimal spatial discretizations for the variables PopulationDensity, Population65, NoHealthInsurance, Neighbor_Disadvantage, Beer, MentalHealthPati, NatureParks, Casinos, DrinkingPlaces, and X.HouseRent, respectively.](../man/figures/sesp/optdisc4-1.png)


``` r
plot_optdisc(g5)
```

![**Figure 6**. Optimal spatial discretization result with geographically weighted regression operator. Subfigures (a)–(j) depict the optimal spatial discretizations for the variables PopulationDensity, Population65, NoHealthInsurance, Neighbor_Disadvantage, Beer, MentalHealthPati, NatureParks, Casinos, DrinkingPlaces, and X.HouseRent, respectively.](../man/figures/sesp/optdisc5-1.png)
