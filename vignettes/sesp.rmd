---
title: "Spatially Explicit Stratified Power Model"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{sesp}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---



### Install and load R packages

```r
install.packages(c("sf","gdverse"), dep = T)
# install.packages("devtools")
devtools::install_github("stscl/sesp",build_vignettes = TRUE,dep = TRUE)
```



``` r
library(sf)
## Linking to GEOS 3.12.1, GDAL 3.8.4, PROJ 9.3.1; sf_use_s2() is TRUE
library(sesp)
library(gdverse)
```

Using the same data as [the gdverse idsa vignette](https://stscl.github.io/gdverse/articles/idsa.html):


``` r
depression = system.file('extdata/Depression.csv',package = 'gdverse') |>
  readr::read_csv() |>
  sf::st_as_sf(coords = c('X','Y'), crs = 4326)
## Rows: 1072 Columns: 13
## ── Column specification ───────────────────────────────────────────────────────────────────────────
## Delimiter: ","
## dbl (13): X, Y, Depression_prevelence, PopulationDensity, Population65, NoHealthInsurance, Neig...
## 
## ℹ Use `spec()` to retrieve the full column specification for this data.
## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.
depression
## Simple feature collection with 1072 features and 11 fields
## Geometry type: POINT
## Dimension:     XY
## Bounding box:  xmin: -83.1795 ymin: 32.11464 xmax: -78.6023 ymax: 35.17354
## Geodetic CRS:  WGS 84
## # A tibble: 1,072 × 12
##    Depression_prevelence PopulationDensity Population65 NoHealthInsurance Neighbor_Disadvantage
##  *                 <dbl>             <dbl>        <dbl>             <dbl>                 <dbl>
##  1                  23.1              61.5         22.5              7.98               -0.0525
##  2                  22.8              58.3         16.8             11.0                -0.254 
##  3                  23.2              35.9         24.5              9.31               -0.0540
##  4                  21.8              76.1         21.8             13.2                 0.0731
##  5                  20.7              47.3         22.0             11                   0.763 
##  6                  21.3              32.5         19.2             13.0                 0.422 
##  7                  22                36.9         19.2             10.8                 0.113 
##  8                  21.2              61.5         15.9              8.57               -0.154 
##  9                  22.7              67.2         15.7             17.8                -0.320 
## 10                  20.6             254.          11.3             12.7                 0.457 
## # ℹ 1,062 more rows
## # ℹ 7 more variables: Beer <dbl>, MentalHealthPati <dbl>, NatureParks <dbl>, Casinos <dbl>,
## #   DrinkingPlaces <dbl>, X.HouseRent <dbl>, geometry <POINT [°]>
```

### SESP With Linear Regression


``` r
system.time({
  g1 = sesp(Depression_prevelence ~ ., data = depression,
            model = 'ols', overlay = 'intersection', cores = 8)
})
## Error in checkForRemoteErrors(val): 8 nodes produced errors; first error: sfj should be an sf object if alpha is not 0 !
## Timing stopped at: 0.73 0.16 15.53
g1
## Error: object 'g1' not found
plot(g1,slicenum = 10) +
  ggplot2::theme(axis.text.x = ggplot2::element_text(
                                  angle = 30,vjust = 0.85,hjust = 0.75)
                )
## Error: object 'g1' not found
```

### SESP With Spatial Lag Regression


``` r
system.time({
  g2 = sesp(Depression_prevelence ~ .,
            data = depression,
            model = 'lag', cores = 8)
})
## Error in checkForRemoteErrors(val): 8 nodes produced errors; first error: sfj should be an sf object if alpha is not 0 !
## Timing stopped at: 3.09 0.5 15.92
g2
## Error: object 'g2' not found
plot(g2,slicenum = 10) +
  ggplot2::theme(axis.text.x = ggplot2::element_text(
                                  angle = 30,vjust = 0.85,hjust = 0.75)
                )
## Error: object 'g2' not found
```

### SESP With Spatial Error Regression


``` r
system.time({
  g3 = sesp(Depression_prevelence ~ .,
            data = depression,
            model = 'error', cores = 8)
})
## Error in checkForRemoteErrors(val): 8 nodes produced errors; first error: sfj should be an sf object if alpha is not 0 !
## Timing stopped at: 1.45 0.23 15.31
g3
## Error: object 'g3' not found
plot(g3,slicenum = 10) +
  ggplot2::theme(axis.text.x = ggplot2::element_text(
                                  angle = 30,vjust = 0.85,hjust = 0.75)
                )
## Error: object 'g3' not found
```

### SESP With Spatial Durbin Regression


``` r
system.time({
  g4 = sesp(Depression_prevelence ~ ., data = depression,
            model = 'lag', durbin = TRUE, cores = 8)
})
## Error in checkForRemoteErrors(val): 8 nodes produced errors; first error: sfj should be an sf object if alpha is not 0 !
## Timing stopped at: 0.86 0.28 16.07
g4
## Error: object 'g4' not found
plot(g4,slicenum = 10) +
  ggplot2::theme(axis.text.x = ggplot2::element_text(
                                  angle = 30,vjust = 0.85,hjust = 0.75)
                )
## Error: object 'g4' not found
```

### SESP With Geographically Weighted Regression


``` r
system.time({
  g5 = sesp(Depression_prevelence ~ .,
            data = depression,
            model = 'gwr', cores = 8)
})
## Error in checkForRemoteErrors(val): 8 nodes produced errors; first error: sfj should be an sf object if alpha is not 0 !
## Timing stopped at: 0.61 0.16 16.01
g5
## Error: object 'g5' not found
plot(g5,slicenum = 10) +
  ggplot2::theme(axis.text.x = ggplot2::element_text(
                                  angle = 30,vjust = 0.85,hjust = 0.75)
                )
## Error: object 'g5' not found
```

### Results of optimal spatial discretization


``` r
plot_optdisc = \(g){
 gmap = sf::st_set_geometry(g$optdisc,sf::st_geometry(depression))

 fig1 = seq_along(g$optdisc) |>
   purrr::map(\(.x) ggplot2::ggplot(data = gmap) +
                ggplot2::geom_sf(ggplot2::aes(color = factor(g$optdisc[,.x,drop = TRUE])),
                                 alpha = .65, size = 0.5) +
                ggplot2::labs(color = 'zones') +
                ggplot2::theme_void() +
                ggplot2::theme(
                  legend.position = "none")
                ) %>%
   patchwork::wrap_plots(ncol = 3, byrow = TRUE) +
   patchwork::plot_annotation(
     tag_levels = 'a',
     tag_prefix = '(',
     tag_suffix = ')',
     tag_sep = '',
     theme = ggplot2::theme(plot.tag = ggplot2::element_text(family = "serif"),
                            plot.tag.position = "topleft"))
 return(fig1)
}
```


``` r
plot_optdisc(g1)
## Error: object 'g1' not found
```


``` r
plot_optdisc(g2)
## Error: object 'g2' not found
```


``` r
plot_optdisc(g3)
## Error: object 'g3' not found
```


``` r
plot_optdisc(g4)
## Error: object 'g4' not found
```


``` r
plot_optdisc(g5)
## Error: object 'g5' not found
```
