---
title: "Why Is Spatially Explicit Discretization Necessary?"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{whysed}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---




We use simulated data comprising 225 cells organized in a 15-row by 15-column grid to illustrate the rationale for employing spatially explicit discretization methods. This simulated dataset is constructed by combining data from three distinct spatial process models, resulting in a stratification with three differentiated strata. In subsequent analyses, all discretization methods applied will discretize the dataset into three strata for the calculation of the q-values. The simulation of spatial data is conducted using the `spdgp` package in R. We compare the q-value estimates obtained through spatially explicit discretization in the SESP model, robust discretization in the Robust Geographical Detector, and conventional natural breaks discretization with the Geodetector. The spatially explicit discretization in the SESP model is implemented using the `sesp` package, robust discretization is achieved using the `gdverse` package, and natural breaks are implemented with the `sdsfun` package.

## Install the necessary R packages

```r
install.packages(c("sf","terra","gstat","gdverse"),dep = TRUE)
# install.packages("devtools")
devtools::install_github("ausgis/sesp",build_vignettes = TRUE,dep = TRUE)
# install.packages("pak")
pak::pak("josiahparry/spdgp")
```

## Simulated independent variable X

### Real Stratification of X


``` r
m = matrix(2,nrow = 15, ncol = 15)
zone1_indice = c(6:9,seq(8,by = -1,length.out = 6))
for (i in seq_along(zone1_indice)) {
  m[seq(1,zone1_indice[i]),i] = 1
}
m[,11:15] = 3
m[13,11] = 2
m[14,11:12] = 2
m[15,11:13] = 2

library(sf)
## Linking to GEOS 3.12.1, GDAL 3.8.4, PROJ 9.3.1; sf_use_s2() is TRUE
library(terra)
## terra 1.7.83
r = terra::rast(m, crs = "EPSG:4326")
names(r) = 'simx_zone'
simx = sf::st_as_sf(terra::as.points(r))
simx
## Simple feature collection with 225 features and 1 field
## Geometry type: POINT
## Dimension:     XY
## Bounding box:  xmin: 0.5 ymin: 0.5 xmax: 14.5 ymax: 14.5
## Geodetic CRS:  WGS 84
## First 10 features:
##    simx_zone         geometry
## 1          1 POINT (0.5 14.5)
## 2          1 POINT (1.5 14.5)
## 3          1 POINT (2.5 14.5)
## 4          1 POINT (3.5 14.5)
## 5          1 POINT (4.5 14.5)
## 6          1 POINT (5.5 14.5)
## 7          1 POINT (6.5 14.5)
## 8          1 POINT (7.5 14.5)
## 9          1 POINT (8.5 14.5)
## 10         1 POINT (9.5 14.5)

library(ggplot2)
ggplot() +
  geom_sf(data = simx, aes(color = factor(simx_zone))) +
  ggplot2::labs(color = 'zones') +
  ggplot2::theme_bw()
```

![**Figure 1**. Strata of simulated independent variable X](man/figures/whysed/real_stratification_x-1.png)

### Generate three sets of continuous data with different properties through stratification of X


``` r
table(simx$simx_zone)
## 
##  1  2  3 
## 63 93 69

set.seed(123)
v1 = rnorm(63,3,1)
set.seed(123)
v2 = rnorm(93,4,1.44)
set.seed(123)
v3 = rnorm(69,5,1.96)

set.seed(123)
u1 = rnorm(63,0,1)
set.seed(123)
u2 = rnorm(93,0,1)
set.seed(123)
u3 = rnorm(69,0,1)

listw1 = spdep::nb2listw(sdsfun::spdep_nb(simx[which(simx$simx_zone==1),]),
                         style = "W", zero.policy = TRUE)
listw2 = spdep::nb2listw(sdsfun::spdep_nb(simx[which(simx$simx_zone==2),]),
                         style = "W", zero.policy = TRUE)
listw3 = spdep::nb2listw(sdsfun::spdep_nb(simx[which(simx$simx_zone==3),]),
                         style = "W", zero.policy = TRUE)

v1 = spdgp::sim_sar(u1, v1, listw1, rho = 0.1)
v2 = spdgp::sim_sar(u2, v2, listw2, rho = 0.3)
v3 = spdgp::sim_sar(u3, v3, listw3, rho = 0.5)

simx_zone = simx$simx_zone
simx_zone[which(simx_zone==1)] = v1
simx_zone[which(simx_zone==2)] = v2
simx_zone[which(simx_zone==3)] = v3

simx$simxv = simx_zone
simx
## Simple feature collection with 225 features and 2 fields
## Geometry type: POINT
## Dimension:     XY
## Bounding box:  xmin: 0.5 ymin: 0.5 xmax: 14.5 ymax: 14.5
## Geodetic CRS:  WGS 84
## First 10 features:
##    simx_zone         geometry     simxv
## 1          1 POINT (0.5 14.5) 2.0080426
## 2          1 POINT (1.5 14.5) 2.9242074
## 3          1 POINT (2.5 14.5) 6.4744873
## 4          1 POINT (3.5 14.5) 3.6863108
## 5          1 POINT (4.5 14.5) 3.6830112
## 6          1 POINT (5.5 14.5) 6.8021666
## 7          1 POINT (6.5 14.5) 4.3612989
## 8          1 POINT (7.5 14.5) 0.9602127
## 9          1 POINT (8.5 14.5) 1.9754552
## 10         1 POINT (9.5 14.5) 2.3657828

ggplot() +
  geom_sf(data = simx, aes(color = simxv)) +
  viridis::scale_color_viridis(option = "magma", direction = -1,name = "simx") +
  ggplot2::theme_bw()
```

![**Figure 2**. Simulated independent variable X](man/figures/whysed/sim_x-1.png)

