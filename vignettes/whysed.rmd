---
title: "Why Is spatially Explicit Discretization Necessary?"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{whysed}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  fig.path = "man/figures/whysed/",
  fig.dpi = 150
)
```


We use simulated data comprising 225 cells organized in a 15-row by 15-column grid to illustrate the rationale for employing spatially explicit discretization methods. This simulated dataset is constructed by combining data from three distinct spatial process models, resulting in a stratification with three differentiated strata. In subsequent analyses, all discretization methods applied will discretize the dataset into three strata for the calculation of the q-values. The simulation of spatial data is conducted using the `spdgp` package in R. We compare the q-value estimates obtained through spatially explicit discretization in the SESP model, robust discretization in the Robust Geographical Detector, and conventional natural breaks discretization with the Geodetector. The spatially explicit discretization in the SESP model is implemented using the `sesp` package, robust discretization is achieved using the `gdverse` package, and natural breaks are implemented with the `sdsfun` package.

## Install the necessary R packages

```r
install.packages(c("sf","terra","gstat","gdverse"),dep = TRUE)
# install.packages("devtools")
devtools::install_github("ausgis/sesp",build_vignettes = TRUE,dep = TRUE)
# install.packages("pak")
pak::pak("josiahparry/spdgp")
```

## Simulated independent variable x

### Real stratification of x

```{r read_stratification_x,fig.width=3.2,fig.height=2.7,fig.cap=knitr::asis_output("**Figure 1**. Strata of simulated independent variable x")}
m = matrix(2,nrow = 15, ncol = 15)
zone1_indice = c(6:9,seq(8,by = -1,length.out = 6))
for (i in seq_along(zone1_indice)) {
  m[seq(1,zone1_indice[i]),i] = 1
}
m[,11:15] = 3
m[13,11] = 2
m[14,11:12] = 2
m[15,11:13] = 2

library(sf)
library(terra)
r = terra::rast(m, crs = "EPSG:4326")
names(r) = 'simx_zone'
simx = sf::st_as_sf(terra::as.points(r))
simx

library(ggplot2)
ggplot() +
  geom_sf(data = simx, aes(color = factor(simx_zone))) +
  ggplot2::labs(color = 'zones') +
  ggplot2::theme_bw()
```

##
